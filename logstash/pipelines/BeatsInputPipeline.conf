input {
  beats {
      id => "BeatsInput"
      port => 5044
      host => "0.0.0.0"
      include_codec_tag => true
   }
}

filter {
  if("[gatewayRegion]"=="N/A") {
    mutate { 
      add_field => { "[@metadata][regionIndexSuffix]" => "" }
    }
  } else {
    mutate { 
      add_field => { "[@metadata][regionIndexSuffix]" => "-%{[gatewayRegion]}" }
    }
    # Second mutate required to make lowercase working
    mutate {
      lowercase => [ "[@metadata][regionIndexSuffix]" ]
    }
  }
  # Cache-Lookup if the index for the region already created before
  memcached {
    hosts => "${MEMCACHED}"
    namespace => "index_status"
    get => { "%{logtype}###%{gatewayRegion}" => "[indexExists]" }
  }
  # If we have nothing in the cache, call the API to create the required index
  if !([indexExists]) {
    http {
      url => "${API_BUILDER_URL}/api/elk/v1/api/setup/index/%{logtype}"
      verb => "POST"
      query => {
        "region" => "%{[gatewayRegion]}"
      }
      cacert => "${API_BUILDER_SSL_CERT}"
      target_body => "indexExists"
      add_field => { "[@metadata][updateCache]" => "true" }
    }
  }
  # If the API-Builder has been called, create a cache entry to avoid further calls
  if([@metadata][updateCache]=="true") {
    memcached {
      hosts => "${MEMCACHED}"
      namespace => "index_status"
      ttl => "0" # This should never expire
      set => { "[indexExists]" => "%{logtype}###%{gatewayRegion}" }
    }
  }
}

output {
  if [logtype] == "openlog" {
      pipeline { 
        send_to => "OpenTraffic" 
        id => "OpenTraffic"
      }
  } else if [logtype] == "trace" {
      pipeline { 
        send_to => "TraceMessages" 
        id => "TraceMessages"
      }
  } else if [logtype] == "events" {
      pipeline { 
        send_to => "Events" 
        id => "Events"
      }
  } else if [logtype] == "domainaudit" {
      pipeline { 
        send_to => "DomainAudit" 
        id => "DomainAudit"
      }
  } else {
    elasticsearch {
      hosts => "${ELASTICSEARCH_HOSTS}"
      ssl => true
      cacert => "${ELASTICSEARCH_CERT}"
      user => "${LOGSTASH_USERNAME}"
      password => "${LOGSTASH_PASSWORD}"
      index => "errors-%{+YYYY.MM.dd}"
    }
  }
# Enable if you would like to see outgoing event messages
#  stdout {
#    codec => rubydebug {
#      metadata => true
#    }
#  }
}