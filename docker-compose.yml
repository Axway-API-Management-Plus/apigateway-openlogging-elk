version: '3.7'
services:
  # Supposed to run side-by-side with the API-Gateway to watch the Open-Traffic Event files and send event to Logstash
  # You may also use a natively installed Filebeat (7.x) instance as long as it using the same configuration filebeat/filebeat.yml
  filebeat:
    image: docker.elastic.co/beats/filebeat:${ELASTIC_VERSION}
    container_name: filebeat
    command: --strict.perms=false
    environment:
      - LOGSTASH=${LOGSTASH}
      - ELASTICSEARCH_HOSTS=${ELASTICSEARCH_HOSTS}
      - ELASTICSEARCH_CLUSTER_UUID=${ELASTICSEARCH_CLUSTER_UUID}
      - ELASTICSEARCH_CRT=${ELASTICSEARCH_CRT}
      - BEATS_SYSTEM_USERNAME=${BEATS_SYSTEM_USERNAME}
      - BEATS_SYSTEM_PASSWORD=${BEATS_SYSTEM_PASSWORD}
      - GATEWAY_NAME=${GATEWAY_NAME}
      - GATEWAY_REGION=${GATEWAY_REGION}
      - FILEBEAT_WORKER=${FILEBEAT_WORKER}
    ports:
      - 9000:9000
    volumes:
      - type: volume
        source: filebeatdata
        target: /usr/share/filebeat/data # Required to make sure that Filebeat remembers the last position, even if the container has been removed
      - /etc/localtime:/etc/localtime:ro # Required to sync timezone of API-Gateway into the Docker-Container
      - ${PWD}/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml
      - ${APIGATEWAY_OPENTRAFFIC_FOLDER}:/var/log/opentraffic
      - ${APIGATEWAY_TRACES_FOLDER}:/var/log/trace
      - ${APIGATEWAY_EVENTS_FOLDER}:/var/log/events
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ${PWD}/certificates:/usr/share/filebeat/config/certificates
    networks:
      - elastic
    logging:
      options:
        max-file: "3"
        max-size: "10m"

  # Is receiving events from Filebeat and does pre-processing
  # https://github.com/elastic/logstash-docker/blob/master/build/logstash/env2yaml/env2yaml.go
  logstash:
    image: docker.elastic.co/logstash/logstash:${ELASTIC_VERSION}
    # This custom entrypoint is required to adjust the variable ELASTICSEARCH_HOSTS from Comma to Space separated
    entrypoint: /usr/share/logstash/scripts/custom-entrypoint.sh
    container_name: logstash
    environment:
      - node.name=Logstash1
      - xpack.monitoring.enabled=true
      - xpack.monitoring.elasticsearch.ssl.certificate_authority=${ELASTICSEARCH_CA}
      - xpack.monitoring.elasticsearch.hosts=[${ELASTICSEARCH_HOSTS}]
      - xpack.monitoring.elasticsearch.username=${LOGSTASH_SYSTEM_USERNAME}
      - xpack.monitoring.elasticsearch.password=${LOGSTASH_SYSTEM_PASSWORD}
      - ELASTICSEARCH_CERT=${ELASTICSEARCH_CRT}
      - ELASTICSEARCH_HOSTS=${ELASTICSEARCH_HOSTS}
      - LOGSTASH_USERNAME=${LOGSTASH_USERNAME}
      - LOGSTASH_PASSWORD=${LOGSTASH_PASSWORD}
      - API_BUILDER_URL=${API_BUILDER_URL}
      - API_BUILDER_SSL_CERT=${API_BUILDER_SSL_CERT}
      - MEMCACHED=${MEMCACHED}
    ports:
      - 5044:5044
    volumes:
      - ${PWD}/logstash/config/pipelines.yml:/usr/share/logstash/config/pipelines.yml
      - ${PWD}/logstash/pipelines:/usr/share/logstash/pipelines
      - ${PWD}/logstash/index_templates:/usr/share/logstash/index_templates
      - ${PWD}/certificates:/usr/share/logstash/config/certificates
      - ${PWD}/logstash/scripts:/usr/share/logstash/scripts
    #command: logstash --path.config /usr/share/logstash/pipelines/pipelines.yml
    depends_on:
      - apibuilder4elastic
      - memcached
    networks:
      - elastic
    logging:
      options:
        max-file: "3"
        max-size: "10m"

  # Memcached is used by the Logstash pipeline to cache API-Lookup information that are used to get the API-Organization
  memcached:
    image: memcached:1.6.6-alpine
    container_name: memcached
    networks:
      - elastic
    logging:
      options:
        max-file: "2"
        max-size: "5m"

  # This is the API-Builder project exposing the API-Gateway Manager REST-API
  apibuilder4elastic:
    image: cwiechmann/apibuilder4elastic:v1.0.0-RC2
    container_name: apibuilder4elastic
    environment:
      - ELASTICSEARCH_HOSTS=${ELASTICSEARCH_HOSTS}
      - ADMIN_NODE_MANAGER=${ADMIN_NODE_MANAGER}
      - API_MANAGER_USERNAME=${API_MANAGER_USERNAME}
      - API_MANAGER_PASSWORD=${API_MANAGER_PASSWORD}
      - API_BUILDER_USERNAME=${API_BUILDER_USERNAME}
      - API_BUILDER_PASSWORD=${API_BUILDER_PASSWORD}
      - API_BUILDER_SSL_KEY=${API_BUILDER_SSL_KEY}
      - API_BUILDER_SSL_CERT=${API_BUILDER_SSL_CERT}
      - API_BUILDER_SSL_KEY_PASSWORD=${API_BUILDER_SSL_KEY_PASSWORD}
      - ENABLE_HTTP_PORT=false
      #- LOG_LEVEL=debug
    ports:
      - 8443:8443
    networks:
      - elastic
    volumes:
      - ${PWD}/certificates:/app/config/certificates
    logging:
      options:
        max-file: "3"
        max-size: "10m"

volumes:
  logs:
  filebeatdata:

networks:
  elastic:
  ingress:
